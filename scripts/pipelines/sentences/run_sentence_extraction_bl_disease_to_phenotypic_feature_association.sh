#!/bin/sh

PROJECT=$1
COLLECTION=$2
TEXT_PIPELINE_KEY=$3
STAGE_LOCATION=$4
TMP_LOCATION=$5
BUCKET=$6

ASSOCIATION="bl_disease_to_phenotypic_feature"

JOB_NAME=$(echo "SENTENCE-EXTRACTION-${ASSOCIATION}-${COLLECTION}" | tr '_' '-')

echo "ASSOCIATION: $ASSOCIATION"
echo "COLLECTION: $COLLECTION"
echo "PROJECT: $PROJECT"
echo "JOB_NAME: $JOB_NAME"

OUTPUT_BUCKET="${BUCKET}/output/sentences/${ASSOCIATION}/${COLLECTION}/${ASSOCIATION}"
ANCESTOR_MAP_FILE_PATH="${BUCKET}/ontology-resources/ontology-class-ancestor-map.tsv.gz"

java -Dfile.encoding=UTF-8 -jar target/tm-pipelines-bundled-0.1.0.jar SENTENCE_EXTRACTION \
--jobName="$JOB_NAME" \
--targetProcessingStatusFlag='NOOP' \
--inputDocumentCriteria="TEXT|TEXT|${TEXT_PIPELINE_KEY}|0.1.0;SECTIONS|BIONLP|${TEXT_PIPELINE_KEY}|0.1.0;SENTENCE|BIONLP|SENTENCE_SEGMENTATION|0.1.0;CONCEPT_ALL|BIONLP|CONCEPT_POST_PROCESS|0.1.0" \
--keywords='' \
--conceptIdsToExclude='HP:0045088|HP:0001259|HP:0041092|HP:0031796|HP:0011011|HP:0001056|HP:0011010|MONDO:0021141|MONDO:0021152|HP:0000005|HP:0000005|MONDO:0017169|MONDO:0024497|MONDO:0000605|HP:0040285|HP:0025304|HP:0030645|HP:0025279|HP:0003676|HP:0030649|HP:0012835|HP:0003674|HP:0020034|HP:0002019|HP:0040282|HP:0040279|HP:0040279|HP:0032322|HP:0030645|HP:0011009|HP:0012829|HP:0030645|HP:0031375|HP:0030650|HP:0011009|HP:0012824|HP:0012828|HP:0012828|HP:0025287|HP:0025145|HP:0003676|HP:0003676|HP:0030645|MONDO:0005070|HP:0002664|MONDO:0021178|MONDO:0021137|MONDO:0002254|MONDO:0021136|HP:0012838|HP:0003680|HP:0031915|HP:0012837|HP:0040282|HP:0040279|HP:0040279|HP:0012840|HP:0410291|HP:0012830|HP:0025275|HP:0012831|HP:0012831|HP:0030646|MONDO:0021137|HP:0040279|HP:0040282|HP:0040282|HP:0040279|HP:0040282|HP:0040282|HP:0003680|HP:0012838|HP:0012834|HP:0200034|HP:0012825|HP:0040283|HP:0012824|HP:0012828|HP:0012828|HP:0100754|HP:0032320|HP:0030212|HP:0012826|HP:0003680' \
--collection="$COLLECTION" \
--overwrite='YES' \
--outputBucket="${OUTPUT_BUCKET}" \
--prefixX='MONDO' \
--placeholderX='@DISEASE$' \
--prefixY='HP' \
--placeholderY='@PHENOTYPICFEATURE$' \
--ancestorMapFilePath="$ANCESTOR_MAP_FILE_PATH" \
--ancestorMapFileDelimiter='TAB' \
--ancestorMapFileSetDelimiter='PIPE' \
--project="${PROJECT}" \
--stagingLocation="$STAGE_LOCATION" \
--gcpTempLocation="$TMP_LOCATION" \
--workerZone=us-central1-c \
--region=us-central1 \
--numWorkers=10 \
--maxNumWorkers=75 \
--autoscalingAlgorithm=THROUGHPUT_BASED \
--runner=DataflowRunner
