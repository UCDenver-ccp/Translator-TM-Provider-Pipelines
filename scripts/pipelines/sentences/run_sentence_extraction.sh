#!/bin/sh

PROJECT=$1
COLLECTION=$2
TEXT_PIPELINE_KEY=$3
TEXT_PIPELINE_VERSION=$4
SECTION_PIPELINE_KEY=$5
SECTION_PIPELINE_VERSION=$6
SENTENCE_PIPELINE_KEY=$7
SENTENCE_PIPELINE_VERSION=$8
CONCEPT_POST_PROCESS_VERSION=$9
ASSOCIATION=${10}
PREFIX_X=${11}
PLACEHOLDER_X=${12}
PREFIX_Y=${13}
PLACEHOLDER_Y=${14}
STAGE_LOCATION=${15}
TMP_LOCATION=${16}
BUCKET=${17}
JAR_VERSION=${18}
OUTPUT_VERSION=${19}
OUTPUT_COLLECTION=${20} # sometimes we want the output directory be be a different name, e.g., bulk, than the collection name. This variable allows for that kind of customization. By default, it should be the same as the COLLECTION.

# ASSOCIATION="bl_chemical_to_disease_or_phenotypic_feature"

JOB_NAME=$(echo "SENTENCE-EXTRACTION-${ASSOCIATION}-${COLLECTION}" | tr '_' '-')

echo "ASSOCIATION: $ASSOCIATION"
echo "COLLECTION: $COLLECTION"
echo "OUTPUT_COLLECTION: $OUTPUT_COLLECTION" 
echo "OUTPUT_VERSION: $OUTPUT_VERSION"
echo "TEXT_PIPELINE_KEY: $TEXT_PIPELINE_KEY"
echo "TEXT_PIPELINE_VERSION: $TEXT_PIPELINE_VERSION"
echo "SECTION_PIPELINE_KEY: $SECTION_PIPELINE_KEY"
echo "SECTION_PIPELINE_VERSION: $SECTION_PIPELINE_VERSION"
echo "SENTENCE_PIPELINE_KEY: $SENTENCE_PIPELINE_KEY"
echo "SENTENCE_PIPELINE_VERSION: $SENTENCE_PIPELINE_VERSION"
echo "CONCEPT_POST_PROCESS_VERSION: $CONCEPT_POST_PROCESS_VERSION"
echo "PREFIX_X: $PREFIX_X"
echo "PLACEHOLDER_X: $PLACEHOLDER_X"
echo "PREFIX_Y: $PREFIX_Y"
echo "PLACEHOLDER_Y: $PLACEHOLDER_Y"
echo "JAR_VERSION: $JAR_VERSION"
echo "PROJECT: $PROJECT"
echo "JOB_NAME: $JOB_NAME"

TSV_OUTPUT_BUCKET="${BUCKET}/output/sentences_tsv/${OUTPUT_VERSION}/${ASSOCIATION}/${OUTPUT_COLLECTION}/${ASSOCIATION}"
DP_INPUT_OUTPUT_BUCKET="${BUCKET}/output/sentences_dp_input/${OUTPUT_VERSION}/${ASSOCIATION}/${COLLECTION}/${ASSOCIATION}"
# ANCESTOR_MAP_FILE_PATH="${BUCKET}/ontology-resources/ontology-class-ancestor-map.tsv.gz"

echo "TSV_OUTPUT_BUCKET: $TSV_OUTPUT_BUCKET"

# for PMCOA - change inputDocumentCriteria beginning to ACTIONABLE_TEXT|TEST|...
java -Dfile.encoding=UTF-8 -jar "target/tm-pipelines-bundled-${JAR_VERSION}.jar" SENTENCE_EXTRACTION \
--jobName="$JOB_NAME" \
--targetProcessingStatusFlag='NOOP' \
--inputDocumentCriteria="ACTIONABLE_TEXT|TEXT|${TEXT_PIPELINE_KEY}|${TEXT_PIPELINE_VERSION};SECTIONS|BIONLP|${SECTION_PIPELINE_KEY}|${SECTION_PIPELINE_VERSION};SENTENCE|BIONLP|${SENTENCE_PIPELINE_KEY}|${SENTENCE_PIPELINE_VERSION};CONCEPT_ALL|BIONLP|CONCEPT_POST_PROCESS|${CONCEPT_POST_PROCESS_VERSION}" \
--keywords='' \
--conceptIdsToExclude='CHEBI:36080|PR:000003944|PR:000011336|CL:0000000|PR:000000001|HP:0045088|HP:0001259|HP:0041092|HP:0031796|HP:0011011|HP:0001056|HP:0011010|MONDO:0021141|MONDO:0021152|HP:0000005|HP:0000005|MONDO:0017169|MONDO:0024497|MONDO:0000605|HP:0040285|HP:0025304|HP:0030645|HP:0025279|HP:0003676|HP:0030649|HP:0012835|HP:0003674|HP:0020034|HP:0002019|HP:0040282|HP:0040279|HP:0040279|HP:0032322|HP:0030645|HP:0011009|HP:0012829|HP:0030645|HP:0031375|HP:0030650|HP:0011009|HP:0012824|HP:0012828|HP:0012828|HP:0025287|HP:0025145|HP:0003676|HP:0003676|HP:0030645|MONDO:0005070|HP:0002664|MONDO:0021178|MONDO:0021137|MONDO:0002254|MONDO:0021136|HP:0012838|HP:0003680|HP:0031915|HP:0012837|HP:0040282|HP:0040279|HP:0040279|HP:0012840|HP:0410291|HP:0012830|HP:0025275|HP:0012831|HP:0012831|HP:0030646|MONDO:0021137|HP:0040279|HP:0040282|HP:0040282|HP:0040279|HP:0040282|HP:0040282|HP:0003680|HP:0012838|HP:0012834|HP:0200034|HP:0012825|HP:0040283|HP:0012824|HP:0012828|HP:0012828|HP:0100754|HP:0032320|HP:0030212|HP:0012826|HP:0003680' \
--collection="$COLLECTION" \
--overwrite='YES' \
--tsvOutputBucket="${TSV_OUTPUT_BUCKET}" \
--dpInputOutputBucket="${DP_INPUT_OUTPUT_BUCKET}" \
--prefixX="${PREFIX_X}" \
--placeholderX="${PLACEHOLDER_X}" \
--prefixY="${PREFIX_Y}" \
--placeholderY="${PLACEHOLDER_Y}" \
--project="${PROJECT}" \
--stagingLocation="$STAGE_LOCATION" \
--gcpTempLocation="$TMP_LOCATION" \
--workerZone=us-central1-c \
--region=us-central1 \
--numWorkers=10 \
--maxNumWorkers=75 \
--autoscalingAlgorithm=THROUGHPUT_BASED \
--runner=DataflowRunner


# --ancestorMapFilePath="$ANCESTOR_MAP_FILE_PATH" \
# --ancestorMapFileDelimiter='TAB' \
# --ancestorMapFileSetDelimiter='PIPE' \
